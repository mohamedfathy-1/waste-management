{% extends 'base.html' %}

{% block title %}Submit Waste Report{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 450px;
        border-radius: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .map-instructions {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-left: 4px solid #3b82f6;
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .form-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-top: 1rem;
        display: none;
    }

    /* Note: Global leaflet-static-markers.css handles all marker static rules */
    /* Additional page-specific styles only if needed */
</style>
{% endblock %}

{% block content %}
<div class="container animate-fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center">
                <div>
                    <h1 class="mb-2"><i class="bi bi-plus-circle-fill text-primary me-2"></i>Submit Waste Report</h1>
                    <p class="text-muted mb-0">Report a waste issue in your community</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Form Section -->
        <div class="col-lg-6 mb-4">
            <div class="form-section animate-fade-in-left">
                <h5 class="mb-4"><i class="bi bi-file-earmark-text me-2"></i>Report Details</h5>

                <form method="post" enctype="multipart/form-data" id="reportForm">
                    {% csrf_token %}

                    <!-- Description -->
                    <div class="mb-4">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            <i class="bi bi-chat-text me-2"></i>Description
                        </label>
                        {{ form.description }}
                        <div class="form-text">Describe the waste issue in detail</div>
                    </div>

                    <!-- Image Upload -->
                    <div class="mb-4">
                        <label for="{{ form.image.id_for_label }}" class="form-label">
                            <i class="bi bi-camera me-2"></i>Photo Evidence
                        </label>
                        {{ form.image }}
                        <div class="form-text">Upload a photo of the waste issue (optional)</div>
                        <img id="imagePreview" class="image-preview" alt="Preview">
                    </div>

                    <!-- Hidden Location Fields -->
                    {{ form.latitude }}
                    {{ form.longitude }}

                    <!-- Location Display -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-geo-alt me-2"></i>Location
                        </label>
                        <div class="alert alert-info mb-0">
                            <div id="locationDisplay">
                                <i class="bi bi-info-circle me-2"></i>
                                Click on the map to select location
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                            <i class="bi bi-send me-2"></i>Submit Report
                        </button>
                        <a href="{% url 'citizen_dashboard' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Map Section -->
        <div class="col-lg-6">
            <div class="animate-fade-in-right">
                <div class="map-instructions">
                    <h6 class="mb-2"><i class="bi bi-lightbulb me-2"></i>How to select location:</h6>
                    <ol class="mb-0 ps-3">
                        <li>Click on the map where the waste issue is located</li>
                        <li>A marker will appear at the selected location</li>
                        <li>You can click again to change the location</li>
                    </ol>
                </div>

                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========================================================================
    // MAP INITIALIZATION - SUBMIT REPORT
    // ========================================================================
    console.log('=== SUBMIT REPORT MAP DEBUG INFO ===');
    
    // Initialize map
    var map = L.map('map').setView([0, 0], 2);
    var marker = null;

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // ========================================================================
    // USER LOCATION DETECTION
    // ========================================================================
    console.log('Requesting user location...');
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            
            console.log('✓ User location obtained:');
            console.log(`  - Latitude: ${lat}`);
            console.log(`  - Longitude: ${lon}`);
            
            map.setView([lat, lon], 13);

            // ========================================================================
            // USER LOCATION MARKER - ABSOLUTE STATIC
            // ========================================================================
            L.marker([lat, lon], {
                draggable: false,
                autoPan: false,
                autoPanOnFocus: false,
                keyboard: false,
                riseOnHover: false,
                riseOffset: 0,
                interactive: true,
                bubblingMouseEvents: false,
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="width: 24px; height: 24px; position: relative; transform: none; transition: none;"><i class="bi bi-person-fill" style="font-size: 24px; color: #3b82f6; display: block; position: absolute; top: 0; left: 0; transform: none; transition: none;"></i></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                })
            }).addTo(map).bindPopup('Your Location', {
                autoPan: false,
                autoPanPadding: [0, 0],
                keepInView: false
            });
            
            console.log('✓ User location marker placed');
        }, function(error) {
            console.error('Geolocation error:', error.message);
        });
    } else {
        console.error('Geolocation not supported');
    }

    // ========================================================================
    // MAP CLICK HANDLER - REPORT LOCATION SELECTION
    // ========================================================================
    map.on('click', function (e) {
        var lat = e.latlng.lat;
        var lon = e.latlng.lng;
        
        console.log('Map clicked:');
        console.log(`  - Latitude: ${lat}`);
        console.log(`  - Longitude: ${lon}`);

        // Remove existing marker
        if (marker) {
            map.removeLayer(marker);
            console.log('Old report marker removed');
        }

        // ========================================================================
        // REPORT LOCATION MARKER - ABSOLUTE STATIC
        // ========================================================================
        marker = L.marker([lat, lon], {
            draggable: false,
            autoPan: false,
            autoPanOnFocus: false,
            keyboard: false,
            riseOnHover: false,
            riseOffset: 0,
            interactive: true,
            bubblingMouseEvents: false,
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="width: 32px; height: 32px; position: relative; transform: none; transition: none;"><i class="bi bi-geo-alt-fill" style="font-size: 32px; color: #ef4444; display: block; position: absolute; top: 0; left: 0; transform: none; transition: none;"></i></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            })
        }).addTo(map);
        
        console.log(`✓ Report marker placed at [${lat}, ${lon}]`);

        // Update form fields
        document.getElementById('id_latitude').value = lat.toFixed(6);
        document.getElementById('id_longitude').value = lon.toFixed(6);
        
        console.log('✓ Form fields updated with coordinates');

        // Update location display
        document.getElementById('locationDisplay').innerHTML = `
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            Location selected: ${lat.toFixed(4)}, ${lon.toFixed(4)}
        `;
        
        console.log('✓ Location display updated');
    });

    // Image preview
    document.getElementById('id_image').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                preview.classList.add('animate-scale-in');
            };
            reader.readAsDataURL(file);
        }
    });

    // Form validation
    document.getElementById('reportForm').addEventListener('submit', function (e) {
        const lat = document.getElementById('id_latitude').value;
        const lon = document.getElementById('id_longitude').value;

        if (!lat || !lon) {
            e.preventDefault();
            WasteManagement.showToast('Please select a location on the map', 'error');
            return false;
        }
    });
</script>
{% endblock %}